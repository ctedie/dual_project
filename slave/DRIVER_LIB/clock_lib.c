/////////////////////////////////////////////////////////////////////////////////
/// \addtogroup clock_lib
/// \{
/// \author Dev
///
///	\brief 
///
///
/// \file
/// \brief Fichier source du module clock_lib
///
///
///
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Includes
/////////////////////////////////////////////////////////////////////////////////
#include <stdint.h>
#include "inc/hw_types.h"
#include "driverlib/sysctl.h"
#include "driverlib/systick.h"

#include "clock_lib.h"

/////////////////////////////////////////////////////////////////////////////////
// Private typedef
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private define
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private macro
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private variables
/////////////////////////////////////////////////////////////////////////////////

static T_CLOCK_INT_OBJECT localClockObject;
/////////////////////////////////////////////////////////////////////////////////
// Exported variables
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private function prototypes
/////////////////////////////////////////////////////////////////////////////////
static void SystemTickIntermediateInt(void);

/////////////////////////////////////////////////////////////////////////////////
// Functions
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
/// \brief Initialisation de l'horloge principale
///
/// \param freq		The clock frequency
///
/// \return 0 always for now
///
/////////////////////////////////////////////////////////////////////////////////
int SysClockInit(T_SYS_CLOCK_FREQ freq)
{

	uint32_t u32SelectedFrequency=0;


	switch (freq)
	{
	case SYS_CLOCK_10MHz:
		u32SelectedFrequency = SYSCTL_SYSDIV_20;
		break;
	case SYS_CLOCK_20MHz:
		u32SelectedFrequency = SYSCTL_SYSDIV_10;
		break;
	case SYS_CLOCK_40MHz:
		u32SelectedFrequency = SYSCTL_SYSDIV_5;
		break;
	case SYS_CLOCK_80MHz:
		u32SelectedFrequency = SYSCTL_SYSDIV_2_5;
		break;
	default:
		break;
	}

    SysCtlClockSet(u32SelectedFrequency | SYSCTL_USE_PLL | SYSCTL_XTAL_16MHZ | SYSCTL_OSC_MAIN);



	return 0;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief return the main Clock value
///
///
/// \return The clock frequency in Hz
///
/////////////////////////////////////////////////////////////////////////////////
uint64_t SystemGetClockValue(void)
{

	return SysCtlClockGet();
}


/////////////////////////////////////////////////////////////////////////////////
/// \brief Récupère le 'tick count' de l'horloge
///
/// \return The tick count
///
/////////////////////////////////////////////////////////////////////////////////
uint64_t GetTickCount(void)
{

	return SysTickValueGet();
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
uint16_t SystemTickInit(uint64_t u64tickPeriod, T_CLOCK_INT_OBJECT *clock)
{

	SysTickPeriodSet((SysCtlClockGet()/1000) * u64tickPeriod);

	SysTickEnable();

	if((clock->pfnIntHandler != NULL) && (clock->pArg != NULL))
	{
		localClockObject.pArg = clock->pArg;
		localClockObject.pfnIntHandler = clock->pfnIntHandler;
		SysTickIntRegister(SystemTickIntermediateInt);
		SysTickIntEnable();
	}


	return 0;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
static void SystemTickIntermediateInt(void)
{

	localClockObject.pfnIntHandler(localClockObject.pArg);
}


///
/// \}
///

/////////////////////////////////////////////////////////////////////////////////
/// \addtogroup flash-driver
/// \{
/// \author Dev
///
///	\brief 
///
///
/// \file
/// \brief Fichier source du module flash-driver
///
///
///
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Includes
/////////////////////////////////////////////////////////////////////////////////

#include <stdint.h>

#include "inc/hw_types.h"
#include "driverlib/sysctl.h"
#include "fatfs/src/diskio.h"
#include "fatfs/src/ff.h"
#include "user_flash_lib.h"

/////////////////////////////////////////////////////////////////////////////////
// Private typedef
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private define
/////////////////////////////////////////////////////////////////////////////////
#define SECTOR_SIZE 512
/////////////////////////////////////////////////////////////////////////////////
// Private macro
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private variables
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Exported variables
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private function prototypes
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Functions
/////////////////////////////////////////////////////////////////////////////////

DSTATUS disk_initialize (BYTE pdrv)
{
	UserFlashInit();
	return 0;
}



DSTATUS disk_status (BYTE pdrv)
{
	return 0;
}



DRESULT disk_read (BYTE pdrv, BYTE* buff, DWORD sector, UINT count)
{
	int32_t err;

	err = UserFlashRead((uint32_t *)buff, (uint32_t)sector, (uint32_t)((count*SECTOR_SIZE)/4));
	if(err==0)
		return RES_OK;
	else
		return RES_ERROR;

}



DRESULT disk_write (BYTE pdrv, const BYTE* buff, DWORD sector, UINT count)
{
	int32_t err;
//	DRESULT res;

	err = UserFlashErase(sector, count);
	if(err<0)
	{
		return RES_ERROR;
	}

	err = UserFlashWrite((uint32_t *)buff, (uint32_t)sector, (uint32_t)((count*SECTOR_SIZE)/4));
	if (err == 0)
	{
		return RES_OK;
	}
	else
	{
		return RES_ERROR;
	}

}



DRESULT disk_ioctl (BYTE pdrv, BYTE cmd, void* buff)
{
	DRESULT res;


	switch (cmd)
	{
		case GET_SECTOR_SIZE :    /* Get sectors on the disk (WORD) */
			*(WORD*)buff = SECTOR_SIZE;
			res = RES_OK;
			break;
		case GET_SECTOR_COUNT:
			*(DWORD*)buff = ((DWORD)UserFlashGetSize() / SECTOR_SIZE);
			res = RES_OK;
			break;
		case GET_BLOCK_SIZE:
			*(DWORD*)buff = (DWORD)UserFlashGetBlockSize();
			res = RES_OK;
			break;
		default:
            res = RES_PARERR;
			break;
	}
	return res;
}

DWORD get_fattime (void)
{
    return    ((1986UL-1980) << 25) // Year = 2007
            | (9UL << 21)           // Month = June
            | (27UL << 16)           // Day = 5
            | (3U << 11)           // Hour = 11
            | (30U << 5)            // Min = 38
            | (0U >> 1)             // Sec = 0
            ;
}



///
/// \}
///

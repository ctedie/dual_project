/////////////////////////////////////////////////////////////////////////////////
/// \addtogroup flash_lib
/// \{
/// \author Dev
///
///	\brief 
///
///
/// \file
/// \brief Fichier source du module flash_lib
///
///
///
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Includes
/////////////////////////////////////////////////////////////////////////////////

#include <stdint.h>
#include <stdbool.h>

//#include "system.h"
#include "inc/hw_ssi.h"
#include "inc/hw_memmap.h"

#include "driverlib/ssi.h"

#include "utils/spi_flash.h"

#include "flash_lib.h"

/////////////////////////////////////////////////////////////////////////////////
// Private typedef
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private define
/////////////////////////////////////////////////////////////////////////////////

#define FLASH_PAGE_SIZE		256
#define FLASH_SECTOR_SIZE	4096
#define FLASH_BLOCK_SIZE	32768
#define FLASH_TOTAL_SIZE	256*FLASH_BLOCK_SIZE

#define FLASH_SECTOR_COUNT	(FLASH_TOTAL_SIZE/FLASH_SECTOR_SIZE)


/////////////////////////////////////////////////////////////////////////////////
// Private macro
/////////////////////////////////////////////////////////////////////////////////
#define MIN(a, b)                          ((a) < (b) ? (a) : (b))
/////////////////////////////////////////////////////////////////////////////////
// Private variables
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Exported variables
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private function prototypes
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Functions
/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void FlashMemWrite(uint32_t u32Address, uint8_t *pu8Data, uint32_t u32Size)
{
	uint8_t status;
	uint16_t partSize=0;
	uint8_t *tmpBuf;
	uint32_t written = 0;



	tmpBuf = pu8Data;

	while(written < u32Size)
	{

		partSize = MIN(FLASH_PAGE_SIZE, (u32Size - written));


		SPIFlashWriteEnable(SSI0_BASE);
		SPIFlashPageProgram(SSI0_BASE, (u32Address + written), &tmpBuf[written], partSize);
		do
		{
			status = SPIFlashReadStatus(SSI0_BASE);
		}while((status & 1) != 0);

		written += partSize;
	}




}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void FlashMemRead(uint32_t u32Address, uint8_t *pu8Data, uint32_t u32Size)
{
	SPIFlashRead(SSI0_BASE, u32Address, pu8Data, u32Size);

}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void FlashMemEraseChip(void)
{
	uint8_t status;

	SPIFlashWriteEnable(SSI0_BASE);
	SPIFlashChipErase(SSI0_BASE);
	do
	{
		status = SPIFlashReadStatus(SSI0_BASE);
	}while((status & 1) != 0);

}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void FlashMemSectorErase(uint32_t u32Address)
{
	uint8_t status;

	SPIFlashWriteEnable(SSI0_BASE);
	SPIFlashSectorErase(SSI0_BASE, u32Address);
	do
	{
		status = SPIFlashReadStatus(SSI0_BASE);
	}while((status & 1) != 0);


}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void FlashMemEraseBlock32(uint32_t u32Address)
{
	uint8_t status;

	SPIFlashWriteEnable(SSI0_BASE);
	SPIFlashBlockErase32(SSI0_BASE, u32Address);
	do
	{
		status = SPIFlashReadStatus(SSI0_BASE);
	}while((status & 1) != 0);

}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void FlashMemEraseBlock64(uint32_t u32Address)
{
	uint8_t status;

	SPIFlashWriteEnable(SSI0_BASE);
	SPIFlashBlockErase64(SSI0_BASE, u32Address);
	do
	{
		status = SPIFlashReadStatus(SSI0_BASE);
	}while((status & 1) != 0);

}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
uint32_t FlashMemGetPageSize(void)
{
	return (uint32_t)FLASH_PAGE_SIZE;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
uint32_t FlashMemGetSectorSize(void)
{
	return (uint32_t)FLASH_SECTOR_SIZE;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
uint32_t FlashMemGetBlockSize(void)
{
	return (uint32_t)FLASH_BLOCK_SIZE;
}


/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
uint32_t FlashMemGetSectorCount(void)
{
	return (uint32_t)FLASH_SECTOR_COUNT;
}

///
/// \}
///

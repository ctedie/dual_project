/////////////////////////////////////////////////////////////////////////////////
/// \addtogroup clock_module
/// \{
/// \author Dev
///
///	\brief
///
///
/// \file
/// \brief Fichier source du module clock
///
///
///
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Includes
/////////////////////////////////////////////////////////////////////////////////
#include "system.h"
#include <time.h>

#include "clock_module.h"

/////////////////////////////////////////////////////////////////////////////////
// Private typedef
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private define
/////////////////////////////////////////////////////////////////////////////////
#define MINUTE_IN_SECOND	60
#define HOUR_IN_SECOND		3600
#define DAY_IN_SECOND		86400
#define MONTH_IN_SECOND		2629743		//30.44 days
#define YEAR_IN_SECOND		31556926	//365.24 days

/////////////////////////////////////////////////////////////////////////////////
// Private macro
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private variables
/////////////////////////////////////////////////////////////////////////////////
static Timer_Handle RTCTimer;

/////////////////////////////////////////////////////////////////////////////////
// Exported variables
/////////////////////////////////////////////////////////////////////////////////
uint32_t ClockSec;

/////////////////////////////////////////////////////////////////////////////////
// Private function prototypes
/////////////////////////////////////////////////////////////////////////////////
static void cbRTCTimer(UArg arg0);

/////////////////////////////////////////////////////////////////////////////////
// Functions
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void CLOCK_init(void)
{
    Bool res;

    RTCTimer = Timer_create(Timer_ANY, cbRTCTimer, NULL, NULL);

    res = Timer_setPeriodMicroSecs(RTCTimer, 1000000);
    if(res == false)
    {
    	while(1)
    	{

    	}
    }

    ClockSec = time(NULL);
    Timer_start(RTCTimer);

}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
uint32_t CLOCK_get(void)
{
	return ClockSec;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void CLOCK_set(uint32_t clkVal)
{
Timer_stop(RTCTimer);

ClockSec = clkVal;

Timer_start(RTCTimer);

}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void CLOCK_getDateTime(tDateTime *pDate)
{
	uint32_t clkVal;
	clkVal = ClockSec;

	pDate->year = clkVal/YEAR_IN_SECOND + 1970;
	pDate->month = ((clkVal/MONTH_IN_SECOND) % 12) + 1;
	pDate->day = (clkVal/DAY_IN_SECOND)%31 + 1;
	pDate->hour = (clkVal/HOUR_IN_SECOND)%24;
	pDate->minute = (clkVal/MINUTE_IN_SECOND)%60;
	pDate->second = (clkVal)%60;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void CLOCK_setDateTime(tDateTime *pDate)
{
	uint32_t clkVal;

	clkVal = (pDate->year - 1970) * YEAR_IN_SECOND
			+(pDate->month - 1) * MONTH_IN_SECOND
			+(pDate->day - 1) * DAY_IN_SECOND
			+pDate->hour * HOUR_IN_SECOND
			+pDate->minute * MINUTE_IN_SECOND
			+pDate->second;

	Timer_stop(RTCTimer);

	ClockSec = clkVal;

	Timer_start(RTCTimer);

}

/////////////////////////////////////////////////////////////////////////////////
/// \brief Updating the date time
///
/// \details With this function you can update only few date/time parameters
/// 		 without discarding the others
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
void CLOCK_updateDateTime(tDateTime *pDate, uint8_t maskParam)
{
	uint32_t clkVal;

	clkVal = ClockSec;

	clkVal = (pDate->year - 1970) * YEAR_IN_SECOND
			+(pDate->month - 1) * MONTH_IN_SECOND
			+(pDate->day - 1) * DAY_IN_SECOND
			+pDate->hour * HOUR_IN_SECOND
			+pDate->minute * MINUTE_IN_SECOND
			+pDate->second;

	Timer_stop(RTCTimer);

	ClockSec = clkVal;

	Timer_start(RTCTimer);

}

/////////////////////////////////////////////////////////////////////////////////
// Static Functions
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
static void cbRTCTimer(UArg arg0)
{
	ClockSec++;
}

///
/// \}
///

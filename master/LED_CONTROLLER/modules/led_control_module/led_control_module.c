/////////////////////////////////////////////////////////////////////////////////
/// \addtogroup led_control_module
/// \{
/// \author Dev
///
///	\brief 
///
///
/// \file
/// \brief Fichier source du module led_control_module
///
///
///
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Includes
/////////////////////////////////////////////////////////////////////////////////
#include <stdint.h>
#include <stdbool.h>

#include <ti/sysbios/hal/Timer.h>

#include "inc/hw_ints.h"
#include "utils/softssi.h"
#include "utils/softuart.h"

#include "system.h"

#include "common.h"
#include "led_control_module.h"
/////////////////////////////////////////////////////////////////////////////////
// Private typedef
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private define
/////////////////////////////////////////////////////////////////////////////////
#define BUFFER_SIZE	16
/////////////////////////////////////////////////////////////////////////////////
// Private macro
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private variables
/////////////////////////////////////////////////////////////////////////////////
tSoftSSI m_ssiHandle;
tSoftUART m_uartHandle;
uint16_t m_rxBuffer[BUFFER_SIZE];
uint8_t m_txBuffer[BUFFER_SIZE];

Timer_Handle m_timerTxHandle;
Timer_Params m_timerTxParams;
Error_Block m_timerTxEb;

Timer_Handle m_timerRxHandle;
Timer_Params m_timerRxParams;
Error_Block m_timerRxEb;

static Hwi_Struct hwiStructGpioRx;


uint64_t m_intNumber = 0;
/////////////////////////////////////////////////////////////////////////////////
// Exported variables
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Private function prototypes
/////////////////////////////////////////////////////////////////////////////////
static void SSICallback(void);
static void UARTCallback(void);
static void UARTGpioCallback(uint32_t arg);
/////////////////////////////////////////////////////////////////////////////////
// Functions
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
bool LED_CONTROL_Init(void)
{
   SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOC);
   GPIOPinConfigure(GPIO_PC4_U7RX);
   GPIOPinConfigure(GPIO_PC5_U7TX);
   GPIOPinTypeUART(GPIO_PORTC_BASE, GPIO_PIN_4 | GPIO_PIN_5);

   SysCtlPeripheralEnable(SYSCTL_PERIPH_UART7);
   UARTConfigSetExpClk(UART7_BASE, CPU_CLOCK, 9600,
						   (UART_CONFIG_PAR_NONE | UART_CONFIG_STOP_ONE |
							UART_CONFIG_WLEN_8));
   UARTIntDisable(UART7_BASE, 0xFFFFFF);
	UARTIntEnable(UART7_BASE, UART_INT_RX | UART_INT_RT);
	UARTIntClear(UART7_BASE, UART_INT_RX | UART_INT_RT);

	//TODO add hwi for rx interrupt
    Hwi_construct(&hwiStructGpioRx, INT_UART7_TM4C129, UARTGpioCallback, NULL, NULL);
//    Hwi_enableInterrupt(INT_UART7_TM4C129);

	return true;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
bool LED_CONTROL_RgbSend(tRGBControl* control)
{

	return true;
}

void LED_CONTROL_Test(uint16_t data)
{
	SoftSSIDataPut(&m_ssiHandle, (uint32_t)data);
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
static void SSICallback(void)
{
	//TODO
	m_intNumber++;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
static void UARTCallback(void)
{
	//TODO
	m_intNumber++;
}

/////////////////////////////////////////////////////////////////////////////////
/// \brief
///
/// \param
///
/// \return
///
/////////////////////////////////////////////////////////////////////////////////
static uint32_t nbInt = 0;
static void UARTGpioCallback(uint32_t arg)
{
	uint32_t status;
	uint8_t car;
	//TODO
	status = UARTIntStatus(UART7_BASE, true);
	car = (uint8_t)UARTCharGet(UART7_BASE);
	UARTIntClear(UART7_BASE, status);
	Hwi_clearInterrupt(INT_UART7_TM4C129);
	nbInt++;
}

///
/// \}
///
